# ESP32 Audio Delay Project

基于 AI Thinker ESP32-A1S-AudioKit 的音频延迟器项目，支持实时音频延迟处理和用户界面控制。

## 硬件要求

- **AI Thinker ESP32-A1S-AudioKit** - 集成 ES8388 音频编解码器 (V2.2 974 版本)
- **EC11 编码器模块** - 带按压功能的旋转编码器
- **0.96 英寸 OLED 显示屏** - SSD1306 控制器，I2C 接口，128x64 像素

**重要说明**：AI Thinker ESP32-A1S-AudioKit 存在多个版本，早期版本使用 AC101 音频编解码器，本项目适用于使用 ES8388 编解码器的 V2.2 974 及以后版本。

## ESP32-A1S-AudioKit 引脚定义

### 官方引脚定义图

![ESP32-A1S-AudioKit 引脚定义](README_images/AI%20Thinker%20esp32-A1S%20ES8388.png)

_图：AI Thinker ESP32-A1S-AudioKit 开发板引脚定义和 ES8388 音频编解码器连接图_

**根据官方引脚定义图，开发板正面（带盖板）的扩展引脚为：**

- **左边**：GND, 3V3, IO39, IO36, IO34, IO0, IO14, IO12, IO13, IO15, IO2, IO4, ...
- **右边**：GND, IO3(RXD0), IO1(TXD0), EN, IO21, IO22, IO19, IO23, IO18, IO5, ...

### 核心功能引脚

#### I2S 音频接口 (与 ES8388 连接)

| 功能             | GPIO   | 说明               |
| ---------------- | ------ | ------------------ |
| I2S_BCK (位时钟) | GPIO27 | I2S 位时钟信号     |
| I2S_WS (字时钟)  | GPIO25 | I2S 字选择信号     |
| I2S_DATA_OUT     | GPIO26 | I2S 数据输出 (DAC) |
| I2S_DATA_IN      | GPIO35 | I2S 数据输入 (ADC) |

#### I2C 控制接口 (ES8388 控制)

| 功能    | GPIO   | 说明       |
| ------- | ------ | ---------- |
| I2C_SDA | GPIO33 | I2C 数据线 |
| I2C_SCL | GPIO32 | I2C 时钟线 |

#### 板载按键

| 按键 | GPIO   | 功能          |
| ---- | ------ | ------------- |
| PLAY | GPIO36 | 播放/暂停按键 |
| SET  | GPIO13 | 设置按键      |
| VOL+ | GPIO19 | 音量增加      |
| VOL- | GPIO18 | 音量减少      |
| MODE | GPIO5  | 模式切换      |
| REC  | GPIO39 | 录音按键      |

#### 板载 LED

| LED      | GPIO   | 说明            |
| -------- | ------ | --------------- |
| 绿色 LED | GPIO22 | 状态指示灯      |
| 红色 LED | GPIO19 | 电源/错误指示灯 |

### 可用 GPIO 引脚 (扩展接口)

基于官方引脚定义图，以下引脚可用于连接外部设备：

| GPIO   | 位置 | 特性         | 推荐用途      |
| ------ | ---- | ------------ | ------------- |
| GPIO0  | 左边 | 启动模式控制 | 按键输入      |
| GPIO2  | 左边 | 通用 IO      | 数字输入/输出 |
| GPIO4  | 左边 | 通用 IO      | 数字输入/输出 |
| GPIO5  | 右边 | 通用 IO      | 数字输入/输出 |
| GPIO12 | 左边 | 通用 IO      | 数字输入/输出 |
| GPIO13 | 左边 | 通用 IO      | 数字输入/输出 |
| GPIO14 | 左边 | 通用 IO      | 数字输入/输出 |
| GPIO15 | 左边 | 通用 IO      | 数字输入/输出 |
| GPIO18 | 右边 | 通用 IO      | 数字输入/输出 |
| GPIO19 | 右边 | 通用 IO      | 数字输入/输出 |
| GPIO21 | 右边 | 通用 IO      | I2C SDA       |
| GPIO22 | 右边 | 通用 IO      | 数字输入/输出 |
| GPIO23 | 右边 | 通用 IO      | I2C SCL       |
| GPIO34 | 左边 | 仅输入       | ADC 输入      |
| GPIO36 | 左边 | 仅输入       | ADC 输入      |
| GPIO39 | 左边 | 仅输入       | ADC 输入      |

## 硬件连接

### 基于可插拔引脚的连接方案

**实际可用扩展引脚**：

- 左边：GND, 3V3, IO39, IO36, IO34, IO0, IO14, IO12, IO13, IO15, IO2, IO4, ...
- 右边：GND, IO3(RXD0), IO1(TXD0), EN, IO21, IO22, IO19, IO23, IO18, IO5, ...

#### EC11 旋转编码器连接

| EC11 引脚  | ESP32-A1S 引脚 | 位置 | 说明            |
| ---------- | -------------- | ---- | --------------- |
| GND        | GND            | 上排 | 电源地          |
| VCC        | 3.3V           | 上排 | 电源正极        |
| S1 (A 相)  | IO22           | 下排 | 编码器 A 相信号 |
| S2 (B 相)  | IO19           | 下排 | 编码器 B 相信号 |
| KEY (按键) | IO0            | 上排 | 按键信号        |

#### OLED 显示屏连接 (SSD1306)

| OLED 引脚 | ESP32-A1S 引脚 | 位置 | 说明       |
| --------- | -------------- | ---- | ---------- |
| GND       | GND            | 下排 | 电源地     |
| VCC       | 3.3V           | 上排 | 电源正极   |
| SDA       | IO21           | 下排 | I2C 数据线 |
| SCL       | IO23           | 下排 | I2C 时钟线 |

**重要提醒**：

- ✅ 使用可插拔扩展引脚，无需飞线焊接
- ✅ 避免与 ES8388 音频编解码器冲突 (GPIO32/33)
- ✅ 避免与板载按键冲突 (GPIO36/39)
- ✅ 使用独立 I2C 总线 (IO21/IO23) 用于 OLED 显示

### 剩余可用引脚

完成 EC11 编码器和 OLED 显示屏连接后，还有以下引脚可用于扩展：

| 引脚   | 位置 | 特性    | 推荐用途                |
| ------ | ---- | ------- | ----------------------- |
| GPIO2  | 左边 | 通用 IO | 数字输入/输出、LED 控制 |
| GPIO4  | 左边 | 通用 IO | 数字输入/输出           |
| GPIO5  | 右边 | 通用 IO | 数字输入/输出、SPI CS   |
| GPIO12 | 左边 | 通用 IO | 数字输入/输出           |
| GPIO13 | 左边 | 通用 IO | 数字输入/输出           |
| GPIO14 | 左边 | 通用 IO | 数字输入/输出           |
| GPIO15 | 左边 | 通用 IO | 数字输入/输出           |
| GPIO18 | 右边 | 通用 IO | 数字输入/输出           |
| GPIO34 | 左边 | 仅输入  | ADC 输入                |
| GPIO36 | 左边 | 仅输入  | ADC 输入                |
| GPIO39 | 左边 | 仅输入  | ADC 输入                |
| IO1    | 右边 | UART TX | 串口通信 (调试时占用)   |
| IO3    | 右边 | UART RX | 串口通信 (调试时占用)   |

## 硬件连接示意图

### 可插拔引脚连接总览

```
                    ESP32-A1S-AudioKit 扩展引脚 (基于官方引脚图)
                    ┌─────────────────────────────────────────────┐
                    │ 左边: GND 3V3 IO39 IO36 IO34 IO0 IO14 IO12 IO13 IO15 IO2 IO4 │
                    │ 右边: GND IO3 IO1 EN IO21 IO22 IO19 IO23 IO18 IO5 ...        │
                    └─────────────────────────────────────────────┘
                                      │
    ┌─────────────┐                  │                  ┌─────────────┐
    │   EC11      │                  │                  │   ES8388    │
    │  编码器     │                  │                  │  音频编解码器│
    │             │                  │                  │             │
    │ S1 ─────────────────────────→ IO22 (右边)        │ SDA ←─ GPIO33│
    │ S2 ─────────────────────────→ IO19 (右边)        │ SCL ←─ GPIO32│
    │ KEY ────────────────────────→ IO0  (左边)        │             │
    │ VCC ────────────────────────→ 3V3  (左边)        │ BCK ←─ GPIO27│
    │ GND ────────────────────────→ GND  (左边)        │ WS  ←─ GPIO25│
    └─────────────┘                  │                  │ DIN ←─ GPIO35│
                                     │                  │ DOUT←─ GPIO26│
    ┌─────────────┐                  │                  └─────────────┘
    │ OLED SSD1306│                  │
    │  显示屏     │                  │                  ┌─────────────┐
    │             │                  │                  │  音频接口   │
    │ SDA ─────────────────────────→ IO21 (右边)       │             │
    │ SCL ─────────────────────────→ IO23 (右边)       │ LINE IN ────┤
    │ VCC ────────────────────────→ 3V3  (左边)        │ HP OUT ─────┤
    │ GND ────────────────────────→ GND  (右边)        └─────────────┘
    └─────────────┘

    大量剩余可用引脚: IO2, IO4, IO5, IO12, IO13, IO14, IO15, IO18, IO34, IO36, IO39
```

### 扩展引脚详细分配

```
ESP32-A1S-AudioKit 可插拔扩展引脚：

上排引脚 (从左到右)：
┌─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│ GND │ IO0 │ RST │ TX0 │ RX0 │ 3V3 │ 3V3 │
└─────┴─────┴─────┴─────┴─────┴─────┴─────┘
   │     │     │     │     │     │     │
   │     │     │     │     │     │     └─ 电源 (OLED, EC11)
   │     │     │     │     │     └─ 电源 (OLED, EC11)
   │     │     │     │     └─ UART RX (调试)
   │     │     │     └─ UART TX (调试)
   │     │     └─ 复位 (系统)
   │     └─ EC11 KEY (按键)
   └─ 电源地 (OLED, EC11)

下排引脚 (从左到右)：
┌─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│IO21 │IO22 │IO19 │IO23 │IO18 │ IO5 │ GND │
└─────┴─────┴─────┴─────┴─────┴─────┴─────┘
   │     │     │     │     │     │     │
   │     │     │     │     │     │     └─ 电源地 (备用)
   │     │     │     │     │     └─ 扩展引脚 (可用)
   │     │     │     │     └─ 扩展引脚 (可用)
   │     │     │     └─ OLED SCL (I2C时钟)
   │     │     └─ EC11 S2 (B相)
   │     └─ EC11 S1 (A相)
   └─ OLED SDA (I2C数据)

连接状态：
✅ 已分配: IO0, IO21, IO22, IO19, IO23
🔓 可用: IO18, IO5
⚠️ 系统: RST, TX0, RX0 (调试时占用)
```

### 最终连接方案总结

基于可插拔扩展引脚的最优连接方案：

| 设备            | 引脚       | ESP32-A1S 引脚 | 引脚位置 | 备注           |
| --------------- | ---------- | -------------- | -------- | -------------- |
| **EC11 编码器** | S1 (A 相)  | IO22           | 下排     | 可插拔，无冲突 |
|                 | S2 (B 相)  | IO19           | 下排     | 可插拔，无冲突 |
|                 | KEY (按键) | IO0            | 上排     | 启动控制引脚   |
| **OLED 显示屏** | SDA        | IO21           | 下排     | 独立 I2C 总线  |
|                 | SCL        | IO23           | 下排     | 独立 I2C 总线  |
| **电源连接**    | VCC        | 3.3V           | 上排     | 所有外设共用   |
|                 | GND        | GND            | 上/下排  | 所有外设共用   |

**注意**：代码中的 GPIO 配置已更新为推荐方案，如需使用其他引脚请修改以下文件：

- `main/include/ec11_encoder.h` - EC11 编码器引脚定义
- `main/include/oled_display.h` - OLED 显示屏引脚定义

### 音频接口

使用 ESP32-A1S-AudioKit 板载的音频接口：

- 音频输入：3.5mm 音频插孔 (AUX IN/LINE IN)
- 音频输出：3.5mm 音频插孔 (耳机输出)

### ESP32-A1S-AudioKit 板载资源

- **音频编解码器**：ES8388
- **板载按键**：6 个功能按键 (PLAY, SET, VOL-, VOL+, MODE, REC)
- **板载 LED**：电源指示灯和状态指示灯
- **MicroSD 卡槽**：支持音频文件存储
- **USB 接口**：供电和程序下载
- **I2C 接口**：用于 ES8388 控制 (SDA: GPIO33, SCL: GPIO32)
- **I2S 接口**：用于音频数据传输

## 功能特性

### 音频处理

- **延迟范围**：0ms - 10000ms (10 秒)
- **延迟精度**：1ms
- **默认延迟**：30ms
- **支持采样率**：44.1kHz, 48kHz, 96kHz, 192kHz
- **默认采样率**：48kHz
- **音频格式**：16 位单声道

### 用户界面

- **主界面**：显示当前延迟时间和采样率
- **菜单界面**：采样率选择菜单
- **交互方式**：
  - 旋转编码器：调整延迟时间或菜单选择
  - 按压编码器：进入菜单或确认选择

### 设置管理

- **持久化存储**：使用 NVS (Non-Volatile Storage)
- **自动保存**：5 秒无操作后自动保存设置
- **启动恢复**：重启后自动恢复上次设置

## 构建和烧录

### 环境准备

1. 安装 ESP-IDF 开发环境
2. 设置环境变量：
   ```bash
   source $HOME/esp/esp-idf/export.sh
   ```

### 构建项目

```bash
# 仅构建
./build_and_flash.sh

# 构建并烧录
./build_and_flash.sh flash

# 构建、烧录并监控
./build_and_flash.sh flash monitor

# 清理并构建
./build_and_flash.sh clean
```

### 手动构建

```bash
# 设置目标芯片
idf.py set-target esp32

# 构建项目
idf.py build

# 烧录到设备
idf.py flash

# 监控串口输出
idf.py monitor
```

## 使用说明

### 基本操作

1. **调整延迟时间**：在主界面旋转编码器
2. **进入菜单**：在主界面按压编码器
3. **选择采样率**：在菜单界面旋转编码器选择，按压确认
4. **退出菜单**：确认选择后自动返回主界面

### 显示界面

- **主界面**：

  ```
  AUDIO DELAY

  DELAY: 30MS

  RATE: 48KHZ
  ```

- **菜单界面**：

  ```
  SAMPLE RATE

  > 44.1KHZ
    48KHZ_
    96KHZ
    192KHZ
  ```

  - `>` 表示当前选择
  - `_` 表示已确认的设置

## 项目结构

```
├── main/
│   ├── include/           # 头文件
│   │   ├── audio_delay.h
│   │   ├── ec11_encoder.h
│   │   ├── oled_display.h
│   │   ├── settings_manager.h
│   │   └── ui_manager.h
│   ├── main.c            # 主程序
│   ├── audio_delay.c     # 音频延迟处理
│   ├── ec11_encoder.c    # EC11编码器驱动
│   ├── oled_display.c    # OLED显示驱动
│   ├── settings_manager.c # 设置管理
│   ├── ui_manager.c      # 用户界面管理
│   └── CMakeLists.txt
├── CMakeLists.txt        # 项目配置
├── sdkconfig.defaults    # 默认配置
├── build_and_flash.sh    # 构建脚本
├── software_requirements.md # 软件需求文档
└── README.md            # 项目说明
```

## 故障排除

### 常见问题

1. **编译错误**：确保 ESP-IDF 环境正确设置
2. **烧录失败**：检查 USB 连接和串口权限
3. **显示屏无显示**：检查 I2C 连接和地址设置
4. **编码器无响应**：检查 GPIO 连接和上拉电阻
5. **音频无输出**：
   - 检查音频连接和采样率设置
   - 确认 ES8388 编解码器初始化正常 (I2C 地址: 0x10)
   - 检查音频输入/输出插孔连接
   - 验证 I2S 配置：BCK=GPIO27, WS=GPIO25, DOUT=GPIO26, DIN=GPIO35
   - 确认 ES8388 的 I2C 控制接口：SDA=GPIO33, SCL=GPIO32

### 调试方法

- 使用 `idf.py monitor` 查看串口日志
- 检查硬件连接
- 验证 GPIO 配置
- 使用板载 LED 指示灯检查系统状态
- 测试板载按键功能确认 GPIO 工作正常
- 检查 ES8388 编解码器的 I2C 通信

## 许可证

本项目基于 MIT 许可证开源。
